<!DOCTYPE html>
<meta charset="utf-8">
<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<script>
  MathJax.Hub.Config({
                      tex2jax: {inlineMath: [['$', '$'], ['\\(','\\)']]},
                      TeX: { equationNumbers: {autoNumber: "AMS"} },
                      "HTML-CSS": { showMathMenu: false,
                                    scale: 90 }
                     });
</script>
<style>

.client {
  fill: white;
  stroke: black;
  stroke-width: 2;
  r: 4;
}

.site {
  fill: black;
  opacity: 0.1;
  r: 3;
}

.c0 { fill: blue; stroke: #000099 }
.c1 { fill: green; stroke: #009900 }
.c2 { fill: red; stroke: #990000}
.c3 { fill: yellow; stroke: #999900 }
.c4 { fill: gray; stroke: #404040 }

.v0 { fill: blue; }
.v1 { fill: green; }
.v2 { fill: red; }
.v3 { fill: yellow; }
.v4 { fill: gray; }


</style>
<body>
  <ul id="nav">
    <li class="current"><a href="#intro">Intro</a></li>
    <li><a href="#problem">Problem</a></li>
    <li><a href="#model">Model</a></li>
    <li><a href="#implementation">Implementation</a></li>
    <li><a href="#demo">Live Demo</a></li>
  </ul>
  <div id="container">
    <div class="section" id="intro">
      <h1>Facility Location</h1>
        <subtitle>with quadratic programming and Gurobi</subtitle>
    </div>

    <div class="section" id="problem">
      <h2><a href="#problem" name="problem">Problem Description</a></h2>
      Problem description goes here
      <p>
        Where to build new hospitals so that distance to drive from different places is minimized.
      </p>
    </div>
    <div class="section" id="model">
      <h2><a href="#model" name="model">Mathematical Model</a></h2>

      <p>Model description goes here.</p>
      
      <p> each point within colored region will be nearest the facility of the same color (note that this
      does not necessarily relate to optimization problem since we minimize sum of distances</p>

    </div>
    <div class="section" id="implementation">
      <h2><a href="#implementation" name="implementation">Implementation</a></h2>
      <p>Below is the full implementation of the model (and the associated data) in
        Gurobi's Python interface:
      </p>
      <pre>
      ### ADD DATA ####
      clients = []; facilities = []; charge = [];
      
      from gurobipy import *
      import math
      
      def distance(a,b):
        dx = a[0] - b[0]
        dy = a[1] - b[1]
        return math.sqrt(dx*dx + dy*dy)

      numFacilities = len(facilities)
      
      numClients = len(clients)
      
      m = Model()
      
      # Add variables
      x = {}
      y = {}
      d = {} # Distance matrix (not a variable)
      
      for j in range(numFacilities):
          x[j] = m.addVar(vtype=GRB.BINARY, name="x%d" % j)
      
      for i in range(numClients):
          for j in range(numFacilities):
              y[(i,j)] = m.addVar(lb=0, vtype=GRB.CONTINUOUS, name="t%d,%d" % (i,j))
              d[(i,j)] = distance(clients[i], facilities[j])
      
      m.update()
      
      # Add constraints
      for i in range(numClients):
          for j in range(numFacilities):
              m.addConstr(y[(i,j)] <= x[j])
      
      for i in range(numClients):
          m.addConstr(quicksum(y[(i,j)] for j in range(numFacilities)) == 1)
      
      m.setObjective( quicksum( charge[j]*x[j] + quicksum(d[(i,j)]*y[(i,j)] for i in range(numClients))
                               for j in range(numFacilities) ), GRB.MINIMIZE)
      
      m.optimize()
      </pre>
    </div>
    <div class="section" id="demo">
      <h2><a href="#demo" name="demo">Live Demo</a></h2>
      <div id="demoarea">
      </div>
      <button onclick="compute()">Compute</button>
    </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
<script>

//Width and height
var width = 800;
var height = 500;

var svg = d3.select("#demoarea")
              .append("svg")
              .attr("width", width)
              .attr("height", height)
              .on("mousedown", addPoint);

// Initial points
var vertices = d3.range(10).map(function(d) {
  return [Math.random() * width, Math.random() * height];
});

// Potential sites for facilities
var sites = [];
var n = 10;
for (var i = 1; i < n; i++) {
  for (var j = 1; j < n; j++) {
    sites.push([width*i/n, height*j/n]);
  }
}

var charge = d3.range(sites.length).map(function(d) { return 200; });

// G object for voronoi
var pathG = svg.append("g");

// G object for animations
var animationG = svg.append("g");

// G object for sites
var sitesG = svg.append("g");

// G object for points
var circleG = svg.append("g");

// G object for facilities
var facilitiesG = svg.append("g");

circleG.selectAll("circle")
       .data(vertices)
       .enter()
       .append("circle")
       .attr("cx", function(d) { return d[0]; })
       .attr("cy", function(d) { return d[1]; })
       .attr("class", "client");

sitesG.selectAll("circle")
       .data(sites)
       .enter()
       .append("circle")
       .attr("cx", function(d) { return d[0]; })
       .attr("cy", function(d) { return d[1]; })
       .attr("class", "site");

function addPoint() {
  var point = d3.mouse(this);
  vertices.push(point);
  circleG.append("circle")
         .attr("cx", point[0])
         .attr("cy", point[1])
         .attr("class", "client");
  
  // Add animation
  animationG.selectAll("circle").remove("circle");
  var anim = animationG.append("circle")
                        .attr("cx", point[0])
                        .attr("cy", point[1])
                        .attr("r", 0)
                        .attr("fill", "black");

  anim.style("opacity", .5)
      .transition()
      .style("opacity", 0)
      .attr("r", 20)
      .duration(200)
      .ease("out");
}

// Function that actually joins the different points of polygon
function polygon(d) {
  return "M" + d.join("L") + "Z";
}

function compute() {
  d3.json('/resource')
    .header('Content-Type', 'application/json')
    .post(JSON.stringify({'clients': vertices,
                          'facilities': sites,
                          'charge': charge }), serverResponse);
}

function serverResponse(error, data) {
   console.log('serverResponse');
   console.log('data', data);
   if (!error) {
      if ('solution' in data) {
          // Import solution and put it into correct format
          var solution = data['solution'];
          
          var facilities = [];
          
          for (var i = 0; i < solution.length; i++) {
            facilities.push(sites[solution[i]]);
          }
          
          facilitiesG.selectAll("circle").remove("circle");
          animationG.selectAll("circle").remove("circle");
          
          var faci = facilitiesG.selectAll("circle")
                     .data(facilities)
                     .enter()
                     .append("circle")
                     .attr("cx", function(d) { return d[0]; })
                     .attr("cy", function(d) { return d[1]; })
                     .attr("class", function(d, i) { return "c" + i % 5; })
                     .attr("r",60)
                     .attr("stroke-width", 2);
          
          var anim = animationG.selectAll("circle")
                     .data(facilities)
                     .enter()
                     .append("circle")
                     .attr("cx", function(d) { return d[0]; })
                     .attr("cy", function(d) { return d[1]; })
                     .attr("class", function(d, i) { return "c" + i % 5; })
                     .attr("r",0)
                     .attr("stroke-width", 0);
        
          faci.style("opacity", 0)
              .style("stroke-opacity", 0)
              .transition()
              .style("opacity", 1)
              .style("stroke-opacity", 1)
              .attr("r", 6)
              .duration(500)
              .delay(function(d, i) { return i*100 });
          
          anim.style("opacity", .5)
              .style("stroke-opacity", .5)
              .transition()
              .style("opacity", 0)
              .style("stroke-opacity", 0)
              .attr("r", 30)
              .duration(500)
              .ease("out")
              .delay(function(d, i) { return i*100 + 300});
          
          pathG.selectAll("path").remove("path");
        
          var voroPath = pathG.selectAll("path")
                              .data(d3.geom.voronoi(facilities))
                              .enter()
                              .append("path")
                              .attr("d", polygon)
                              .attr("class", function(d, i) { return "v" + i % 5; })
                              .attr("stroke-opacity", 0);
          
          voroPath.style("opacity", 0)
                  .transition()
                  .style("opacity", .5)
                  .duration(1000)
                  .delay(1000);
        }
      }
}

</script>